<%= stylesheet_link_tag "publishes" %>

<script type="text/javascript">

    $(document).ready(function() {

       $('#loading').hide();   
       $('.product-op').hide();
       $("#myModal").modal('show');


        // jquery validate
        /*$.validator.addMethod("greaterThan",function (value, element, param) {
          var $element = $(element)
              , $min;
          if (typeof(param) === "string") {
              $min = $(param);
          } else {
              $min = $("#" + $element.data("min"));
          }
          if (this.settings.onfocusout) {
            $min.off(".validate-greaterThan").on("blur.validate-greaterThan", function () {
              $element.valid();
            });
          }
          return parseInt(value) > parseInt($min.val());
        }, "Max must be greater than min");

        $.validator.addClassRules({
          greaterThan: {
            greaterThan: true
          }
        });*/

        $("#price-form").validate({
            rules: {
                "product[price]": {
                    required: true
                },
            },

            highlight: function(element) {
                $(element).closest(".form-group").addClass('has-error');
            },
            unhighlight: function(element) {
                $(element).closest('.form-group').removeClass('has-error');
            },

            messages: {
              "product[price]" : "请输入1-100之间的比例",
            },

            errorElement: 'span',
            errorClass: 'help-block',
            errorPlacement: function(error, element) {
                if(element.parent('.input-group').length) {
                    error.appendTo(element.parent());
                } else {
                    error.appendTo(element.parent());
                }
            },
            submitHandler: function(form) {
                //jQuery(form).ajaxSubmit(options);
                //form.submit();
                //$("#loading").show();
                update_price("",false);
            }
        });

        var options = {
            dataType: 'html',
            success: function(data) {
                $("#publish_view").html(data);
                $("#uploading").hide();
                $("#making").show();
                preview_products();
            }
        };

        /*$('#upload_pic').click(function() {

            $('.form-group').each(function() {
                if($(this)[0].is(".has-error") == true) {
                    return
                }
            });

            $("#upload_form").ajaxForm(options).submit();  
            $("#pre").hide();
            $("#uploading").show();
            $("#myModal").modal('hide');
        });*/

        $('#myModal').on('hidden.bs.modal', function (e) {
       
        });


        // confrim tougao
        $('#btn-confirm-tougao').click(function(){
            //$("#loading").show();
            $.ajax({
                url: "/users/<%= current_user.id %>/publishes/commit",
                method: "put",
                dataType: "text",
                data: {publish_id:$("#publish_id").val()},
                success: function(data) {
                    $("#loading").hide();
                    //console.log("success");
                    //console.log(data);
                    flash(data);
                    location.href = "<%= user_publishes_path(current_user) %>"
                },
                error: function(data){
                    $("#loading").hide();
                    //console.log("error");
                    //console.log(data);
                    flash(data);
                }
            });
        });


        // cancel tougao
        $('#btn-re-tougao').click(function(){
            //$("#loading").show();
            $.ajax({
                url: "/users/<%= current_user.id %>/publishes/reset",
                method: "delete",
                dataType: "text",
                data: {publish_id:$("#publish_id").val()},
                success: function(data) {
                    $("#loading").hide();
                    //console.log("success");
                    //console.log(data);
                    flash(data);
                    location.href = "<%= new_user_publish_path(current_user) %>"
                },
                error: function(data){
                    $("#loading").hide();
                    //console.log("error");
                    //console.log(data);
                    flash(data);
                }
            });
        });


        // view image that going to be uploaded
        $("input[type='file']").change(function(evt) {
            var files = evt.target.files;

            for (var i = 0,
            f; f = files[i]; i++) {

                if (!f.type.match('image.*')) {
                    continue;
                }

                var reader = new FileReader();

                reader.onload = (function(theFile) {
                    return function(e) {
                        $(".publish-image img").attr("src", e.target.result); //预览图片的位置  
                        //$("#pre").hide();               
                    };
                })(f);

                reader.readAsDataURL(f);
            }
        });

        // jquery validate
        $("#upload_form").validate({
            rules: {
                "publish[name]": {
                    required: true,
                    maxlength:20,
                    minlength:5
                },
                "publish[description]": {
                    required: true,
                    maxlength:50,
                    minlength:20
                },
                "publish[publish_image]": {
                    required: true
                }
            },

            messages: {
              "publish[publish_image]" : "<%= t('modal.upload.errors.upload_publish') %>",
              "publish[name]": {
                required: "<%= t('modal.upload.errors.input_name') %>",
                maxlength: "<%= t('modal.upload.errors.name_too_long') %>",
                minlength: "<%= t('modal.upload.errors.name_too_short') %>"
              },
              "publish[description]": {
                maxlength:  "<%= t('modal.upload.errors.description_too_long') %>",
                required: "<%= t('modal.upload.errors.input_description') %>",
                minlength: "<%= t('modal.upload.errors.description_too_short') %>"
              }
            },


            highlight: function(element) {
                $(element).closest(".form-group").addClass('has-error');
            },
            unhighlight: function(element) {
                $(element).closest('.form-group').removeClass('has-error');
            },

            errorElement: 'span',
            errorClass: 'help-block',
            errorPlacement: function(error, element) {
                if(element.parent('.input-group').length) {
                    error.insertAfter(element.parent());
                } else {
                    error.insertAfter(element.parent());
                }
            },
            submitHandler: function(form) {
                jQuery(form).ajaxSubmit(options);
                $("#pre").hide();
                $("#uploading").show();
                $("#myModal").modal('hide');
            }
        });

    });

    var preview_products = function() {
        var options = {
            target: '#products_view',
            url: '/products/preview',
            data: {publish_id:$("#publish_id").val()},
            success: function(data) {
                $("#making").hide();
                $("#products_view").html(data);
                var $container = $("#products_view");
                $container.imagesLoaded(function() {
                    $container.masonry({
                          itemSelector: '.col-sm-2',
                          isAnimated: true, 
                          animationOptions: {
                            duration: 700,
                            easing: 'linear',
                            queue: false
                          }              
                       });
                $('#nav').slideUp('slow');   
                $('.product-op').slideDown('slow');
                });

    
            }
        };

        $.ajax(options);

        /*$('#products_view').waterfall({
            itemCls: 'item',
            fitWidth: true,
            colWidth: 222,  
            gutterWidth: 15,
            gutterHeight: 15,
            isFadeIn: true,
            isAnimated: true,
            checkImagesLoaded: false,
            debug: true,
            dataType: 'html',
            path: function(page) {
                return '/products/preview?' + 'publish_id=' + $("#publish_id").val();
            }
        });
        $("#loading").hide();*/
    };


    function product_delete(event) {
            $("#loading").show();
            var id = $(event.target).attr('id');
            $.ajax({
                type: "delete",
                url: "/users/<%= current_user.id %>/products/" + id.split("-")[1],
                dataType: "text",
                beforeSend: function(XMLHttpRequest) {
                    this; //调用本次ajax请求时传递的options参数
                },
                success: function(data) {
                    $("#loading").hide();
                    console.log("success");
                    console.log(data);
                    flash(data);
                    $("#"+id).parent().parent().parent().remove();
                }, 
                error: function(data) {
                  console.log("error");
                  console.log(data);
                  $("#loading").hide();
                  flash(data.responseText);
                }
            });
    }

    // update price in browser
    function set_price(price_ratio) {
        $('input[name="product[price]"]').each(function(){
            var price = $(this).val();
            $(this).val(price * (1 + price_ratio / 100));
        });
    }

    function update_price(event,single) {
        var options = {}
        if(single == false) {
            product_price_ratio = $("#product_price").val();

            if(product_price_ratio > 0 && product_price_ratio <= 100) {

                options = {
                    method: 'put',
                    dataType: "text",
                    url: "/users/<%= current_user.id %>/products/setpriceonce",
                    data: {publish_id:$("#publish_id").val(),price_ratio:product_price_ratio},
                    success: function(data) {
                        $("#loading").hide();
                        //console.log("success");
                        //console.log(data);
                        set_price(product_price_ratio);
                        $("#product_price").val("");
                        flash(data);  
                        },
                    error: function(data) {
                        //console.log("error");
                        //console.log(data);
                        $("#loading").hide();
                        flash(data.responseText);
                    }
                };

            } else {

                var options = {
                    placement: 'top',
                    trigger: 'manual',
                    content: function () {
                        return '<div class="body"><p><%= t("product.input_price_ratio_error") %></p></div>'
                    },
                    container: 'body',
                    html: 'true'
                  };

                  $("#product_price").popover(options);
                  $("#product_price").popover('show');
                  window.setTimeout(function(){
                    $("#product_price").popover('destroy');},2000);


                return;
            }

        } else {
            id = event.target.id.split('_')[2];
            input_price = $(event.target).prev();
            hidden_price = $(event.target).prev().prev();
            product_price = input_price.val();
            base_price = hidden_price.val();

            if(base_price * 2 < product_price || base_price > product_price) {
                //input_price.css("border", "1px solid red");

                var options = {
                    placement: 'top',
                    trigger: 'manual',
                    content: function () {
                        return '<div class="body"><p><%= t("product.input_price_more_than") %>' + base_price + "</em><%= t('product.end_to_price_more_than') %></div>"
                    },
                    container: 'body',
                    html: 'true'
                  };

                  input_price.popover(options);
                  input_price.popover('show');
                  window.setTimeout(function(){
                    input_price.popover('destroy');},1500);

                return;
            }

            options = {
                method: 'patch',
                dataType: "text",
                url: "/users/<%= current_user.id %>/products/" + id,
                data: {price:product_price},
                success: function(data) {
                    $("#loading").hide();
                    //console.log("success");
                    //console.log(data);
                    flash(data); 
                    },
                error: function(data) {
                    //console.log("error");
                    //console.log(data);
                    $("#loading").hide();
                    flash(data.responseText);
                }
            };
        }
        
        $("#loading").show();
        console.log(options);
        $.ajax(options);
    };

    function flash(data) {
        $(".alert span").text(data);
        $(".alert").slideDown('slow');
        window.setTimeout(function() {
            $(".alert").slideUp(500, function(){
                $(this).hide(); 
            });
        }, 1500);
    }

</script>

<style type="text/css">
    .col-sm-2 {
        width: 20%;
        margin-bottom: 10px;
    }

    .publish-info {
        width:45%;
        float:right;
    }

    .product-op {
        margin-top: 50px;
        border-bottom: 1px solid #e6e6e6;
        height: 50px;
    }

    .product-op .left {
        float: left
    }

    .product-op .left label {
        float: left;
        padding-top: 5px;
        padding-right: 10px;
        width: 120px;
    }

    .product-op .right {
        float: right
    }

    .product-op .right button {
        margin-top: 5px;
    }

    .line-price {
        height: 45px;     
    }

    .line-price span {
        float: left;
        padding: 10px;
        padding-right: 5px;
    }

    .line-bottom a{
        color:white;
    }

    .line-bottom  a:hover{
        text-decoration: none;
    }

    #loading {
        text-align: center;
    }

    #price-input-group {
        width: 220px;
        position: absolute;
        margin-left: 100px;
    }

    #product_price {
        padding-left: 20px;
        text-align: right;
        background: url("/assets/percent.png") no-repeat scroll left center transparent;
    }

    #price-submit {
        margin-left: 205px
    }


</style>
    <!--
    # upload file
    # upload success - > request preview products
    # load products
    # confirm products
    # backend - save and clean products-->

<body id="top">
    <div class="contents">
        <%= render "home/nav" %>
            <div style="height:76px">
            </div>
            <div class="container">

                        <div class="clear">
                        </div>

                        <%= render "upload" %>

                        <div style="margin-top: 10px">
                        <div class="left-cont">
                            <div id="publish_view" style="display:none">
                            </div>
                        </div>

                        <div id="loading"><%= image_tag "/assets/loading.gif", style: "margin-right: 10px" %></div>
                        <div class="product-op">

                            <div class="left">
                                <form class="form-inline" role="form" id="price-form">
                                  <div class="form-group">
                                    <label for="product_price"><%= t('product.set_uniform_price') %>:</label>
                                    <div class="input-group" id="price-input-group">
                                        <input type="number" min="1" max="100" pattern="\d+" class="form-control" id="product_price" name="product[price]" placeholder="<%= t('product.input_price_ratio') %>">
                                    </div>
                                  </div>
                                  <button type="submit" id="price-submit" class="btn btn-default" ><%= t('nav.ok') %></button>
                                </form>
                            </div>

                            <div class="right" style="float:right">  

                                <a role="button" id="btn-confirm-tougao" class="btn btn-success"><%= t('product.confirm_tougao') %></a>
                                <a id="btn-re-tougao" class="publish-delete btn btn-danger" role="button"><%= t('product.re_tougao') %></a>    
                            </div>

                        </div>

                        <div id="products_view" class="right-cont">
                                <!--把图片资源添加到此处 例如： <div class="col-sm-2">
                                <div class="graybox">
                                <div class="imgarea">
                                <a class="example-image-link" href="./img/example2.gif" data-lightbox="example-set" title="『新生 軟式globe』">
                                <img class="example-image" src="./img/example2.gif" alt="" /></a>
                                </div>
                                <p class="itemtitle">『新生 軟式globe』</p>
                                </div 
                                </div>  
                                -->
                            <%= render "loading" %>
                        </div>
                        <!--products_view-->
                        <div class="clear"></div>
            </div><!--container-->

    </div><!--contents-->
</body>