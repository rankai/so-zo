Array.prototype.del=function(t){t.sort();for(var n=this.concat([]),r=t.length-1;r>=0;r--)n=n.slice(0,t[r]).concat(n.slice(t[r]+1));return n},HTMLImageElement.prototype.loadOnce=function(t){var n=0;this.onload=function(){n||t.call(this,null),n++}},function(t){var n={lib:[],init:function(){this.require("config")},module:function(t,n){this.lib[t]=n.call(null,this)},require:function(t){var n=this,r=document.createElement("script");document.body.appendChild(r),r.src="./js/module/"+t+".js",r.onload=r.onerror=function(t){n.handlerror(t)}},handlerror:function(){},destroySelf:function(n){throw delete window[t],Error(n)},reflect:function(t,n,r){return t=this.lib.config.getModuleName(t),this.lib[t].process(n,r)},reflectEasy:function(t){return t=this.lib.config.getEasyFun(t),this.lib.easy.getFun(t)},add:function(t,n,r,a,e,i,o,s){return this.lib.addLayer.add(t,n,r,a,e,i,o,s)},applyMatrix:function(){}};window[t]=function(n,r,a){if(!(this instanceof window[t]))return new window[t](n,r,a);this.startTime=+new Date;var e=document.createElement("canvas"),i=e.getContext("2d");isNaN(n)?(e.width=parseInt(n.width),e.height=parseInt(n.height),r=getComputedStyle(n),imgWidth=parseInt(r.getPropertyValue("width")),imgHeight=parseInt(r.getPropertyValue("height")),isNaN(imgWidth)?i.drawImage(n,0,0):i.drawImage(n,0,0,imgWidth,imgHeight)):(e.width=n,e.height=r,i.fillStyle=a||"#fff",i.fillRect(0,0,n,r)),this.canvas=e,this.context=i,this.imgData=i.getImageData(0,0,e.width,e.height),this.name=t+"_"+Math.random(),this.canvas.id=this.name,this.layers=[],n=document.createElement("canvas"),n.width=e.width,n.height=e.height,this.ctxCanvas=n,this.ctxContext=e.getContext("2d")},window[t].module=function(t,r){n.module(t,r)},window[t].dorsyMath=function(){return n.lib.dorsyMath},window[t].prototype={act:function(t){var r=[],r=Array.prototype.slice.call(arguments,1);return n.reflect(t,this.imgData,r),this},view:function(t,n,r,a,e){var i=this.clone();return i.type=1,this.addLayer(i,"正常",0,0),i.act(t,n,r,a,e),this},excute:function(){var t=this.layers,n=t.length;t[n-1]&&1==t[n-1][0].type&&(this.imgData=t[n-1][0].imgData,delete t[n-1])},cancel:function(){var t=this.layers,n=t.length;t[n-1]&&1==t[n-1][0].type&&delete t[n-1]},show:function(n,r){var a=new window[t](this.canvas.width,this.canvas.height);a.add(this,"正常",0,0,r),this.tempPsLib=a;for(var e=0;e<this.layers.length;e++){var i=this.layers[e],o=i[0].layers,s=i[0];o[o.length-1]&&1==o[o.length-1][0].type&&(s=o[o.length-1][0]),a.add(s,i[1],i[2],i[3],r)}return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.putImageData(a.imgData,0,0),n?document.querySelector(n).appendChild(this.canvas):document.body.appendChild(this.canvas),this},replace:function(t){return t&&(t.onload=function(){},t.src=this.save()),this},add:function(){var t,r,a,e,i,o=[];for(a=0;a<arguments.length;a++)if(a)switch(typeof arguments[a]){case"string":/\d+%/.test(arguments[a])?r=arguments[a].replace("%",""):/[RGB]+/.test(arguments[a])?i=arguments[a]:t=arguments[a];break;case"number":o.push(arguments[a]);break;case"boolean":e=arguments[a]}return a=o[0]||0,o=o[1]||0,this.imgData=n.add(this.imgData,arguments[0].imgData,t||"正常",r/100||1,a,o,e||!1,i||"RGB"),this},addLayer:function(t,n,r,a){return this.layers.push([t,n,r,a]),this},clone:function(){var n=new window[t](this.canvas.width,this.canvas.height);return n.context.putImageData(this.imgData,0,0),n.imgData=n.context.getImageData(0,0,this.canvas.width,this.canvas.height),n},swap:function(t,n){var r=this.layers[t];return this.layers[t]=this.layers[n],this.layers[n]=r,this},deleteLayers:function(t){this.layers=this.layers.del(t)},save:function(n){if(!this.layers.length)return this.context.putImageData(this.imgData,0,0),this.canvas.toDataURL();var r=new window[t](this.canvas.width,this.canvas.height);r.add(this,"正常",0,0,n),this.tempPsLib=r;for(var a=0;a<this.layers.length;a++){var e=this.layers[a],i=e[0].layers,o=e[0];i[i.length-1]&&1==i[i.length-1][0].type&&(o=i[i.length-1][0]),r.add(o,e[1],e[2],e[3],n)}return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.putImageData(r.imgData,0,0),this.canvas.toDataURL()},drawRect:function(){var t;(t=document.getElementById("imgRect"))||(t=document.createElement("canvas"),t.id="imgRect",document.body.appendChild(t),t.width=parseInt(this.canvas.width),t.height=parseInt(this.canvas.height));var n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);for(var r=[],a=this.tempPsLib.imgData.data,e=0,i=a.length;i>e;e++)r[a[e]]?r[a[e]]++:r[a[e]]=1;for(n.beginPath(),n.moveTo(0,t.height),e=a=0;255>e;e++)r[e]>a&&(a=r[e]);for(e=0;255>e;e++)i=r[e]||0,i=t.height-.8*(i/a)*t.height,n.lineTo(e/256*t.width,i,1,1);n.lineTo(t.width+10,t.height),n.fill()},ps:function(t){var r;return r=n.reflectEasy(t).call(this),this.logTime("组合效果"+t),r},logTime:function(t){console.log(t+": "+(+new Date-this.startTime)/1e3+"s")},ctx:function(t){var n=this.ctxContext;return n.putImageData(this.imgData,0,0),t.call(n),this.imgData=n.getImageData(0,0,this.canvas.width,this.canvas.height),this}}}("psLib"),window.AlloyImage=$AI=window.psLib,function(t){window[t].module("ImageEnhance",function(){return{process:function(t){for(var n=t.data,r=0,a=n.length;a>r;r+=4);return t.data=n,t}}})}("psLib"),function(t){window[t].module("addLayer",function(){return{add:function(t,n,r,a,e,i,o,s){o=t.data;var h=n.data;e=e||0,i=i||0,a=a||1,s=s||"RGB",/[RGB]+/.test(s)||(s="RGB");var c,u=s.replace("R","0").replace("G","1").replace("B","2");s=t.width;var d=h.length;n=n.width;for(var f,l,u=[-1<u.indexOf("0"),-1<u.indexOf("1"),-1<u.indexOf("2")],p=0,g=o.length;g>p;p+=4)if(f=p/4,l=parseInt(f/s),f%=s,l-=i,f-=e,l=l*n+f,l*=4,l>=0&&d-4>l&&n>f&&f>=0)for(f=0;3>f&&0!=h[l+3];f++)switch(o[p+3]=h[l+3],r){case"颜色减淡":u[f]&&(c=o[p+f]+o[p+f]*h[l+f]/(255-h[l+f]),o[p+f]=(1-a)*o[p+f]+a*c);break;case"变暗":u[f]&&(c=o[p+f]<h[l+f]?o[p+f]:h[l+f],o[p+f]=(1-a)*o[p+f]+a*c);break;case"变亮":u[f]&&(c=o[p+f]>h[l+f]?o[p+f]:h[l+f],o[p+f]=(1-a)*o[p+f]+a*c);break;case"正片叠底":u[f]&&(c=parseInt(o[p+f]*h[l+f]/255),o[p+f]=(1-a)*o[p+f]+a*c);break;case"滤色":u[f]&&(c=parseInt(255-(255-o[p+f])*(255-h[l+f])/255),o[p+f]=(1-a)*o[p+f]+a*c);break;case"叠加":u[f]&&(c=127.5>=o[p+f]?o[p+f]*h[l+f]/127.5:255-(255-o[p+f])*(255-h[l+f])/127.5,o[p+f]=(1-a)*o[p+f]+a*c);break;case"强光":u[f]&&(c=127.5>=h[l+f]?o[p+f]*h[l+f]/127.5:o[p+f]+(255-o[p+f])*(h[l+f]-127.5)/127.5,o[p+f]=(1-a)*o[p+f]+a*c);break;case"差值":u[f]&&(c=o[p+f]>h[l+f]?o[p+f]-h[l+f]:h[l+f]-o[p+f],o[p+f]=(1-a)*o[p+f]+a*c);break;case"排除":u[f]&&(c=o[p+f]+h[l+f]-o[p+f]*h[l+f]/127.5,o[p+f]=(1-a)*o[p+f]+a*c);break;case"点光":u[f]&&(c=o[p+f]<2*h[l+f]-255?2*h[l+f]-255:o[p+f]<2*h[l+f]?o[p+f]:2*h[l+f],o[p+f]=(1-a)*o[p+f]+a*c);break;case"颜色加深":u[f]&&(c=255-255*(255-o[p+f])/h[l+f],o[p+f]=(1-a)*o[p+f]+a*c);break;case"线性加深":u[f]&&(c=o[p+f]+h[l+f],c=c>255?c-255:0,o[p+f]=(1-a)*o[p+f]+a*c);break;case"线性减淡":u[f]&&(c=o[p+f]+h[l+f],c=c>255?255:c,o[p+f]=(1-a)*o[p+f]+a*c);break;case"柔光":u[f]&&(c=127.5>h[l+f]?((2*h[l+f]-255)*(255-o[p+f])/65025+1)*o[p+f]:(2*h[l+f]-255)*(Math.sqrt(o[p+f]/255)-o[p+f]/255)+o[p+f],o[p+f]=(1-a)*o[p+f]+a*c);break;case"亮光":u[f]&&(c=127.5>h[l+f]?255*(1-(255-o[p+f])/(2*h[l+f])):o[p+f]/(2*(1-h[l+f]/255)),o[p+f]=(1-a)*o[p+f]+a*c);break;case"线性光":u[f]&&(c=o[p+f]+2*h[l+f]-255,c=c>255?255:c,o[p+f]=(1-a)*o[p+f]+a*c);break;case"实色混合":u[f]&&(c=h[l+f]<255-o[p+f]?0:255,o[p+f]=(1-a)*o[p+f]+a*c);break;default:u[f]&&(c=h[l+f],o[p+f]=(1-a)*o[p+f]+a*c)}return t}}})}("psLib"),function(t){window[t].module("brightness",function(){return{process:function(t,n){for(var r=t.data,a=n[0]/50,e=Math.tan((45+44*((n[1]||0)/50))*Math.PI/180),i=0,o=r.length;o>i;i+=4)for(var s=0;3>s;s++)r[i+s]=(r[i+s]-127.5*(1-a))*e+127.5*(1+a);return t}}})}("psLib"),function(t){window[t].module("applyMatrix",function(t){return{process:function(n){for(var r=n.data,a=n.width,e=new t.lib.dorsyMath.Matrix([-2,-4,-4,-4,-2,-4,0,8,0,-4,-4,8,24,8,-4,-4,0,8,0,-4,-2,-4,-4,-4,-2],25,1),i=[],o=0,s=r.length;s>o;o+=4){var h=o/4,c=parseInt(h/a),u=h%a;if(0!=c&&0!=u){for(var d=[[],[],[]],f=-2;3>f;f++)for(var l=c+f,p=-2;3>p;p++)for(var g=4*(l*a+(u+p)),h=0;3>h;h++)d[h].push(r[g+h]);for(c=new t.lib.dorsyMath.Matrix(d,3,matrixSize).mutiply(e),h=0;3>h;h++)i[o+h]=c.data[h];i[o+4]=r[o+4]}}for(o=0,s=r.length;s>o;o++)r[o]=i[o]||r[o];return n}}})}("psLib"),function(t){window[t].module("config",function(){var t={"灰度处理":"toGray","反色":"toReverse","灰度阈值":"toThresh","高斯模糊":"gaussBlur","亮度":"brightness","浮雕效果":"embossment","查找边缘":"borderline","色相/饱和度调节":"setHSI","马赛克":"mosaic","油画":"oilPainting","腐蚀":"corrode","锐化":"sharp","添加杂色":"noise","曲线":"curve","暗角":"darkCorner","喷点":"dotted"},n={"美肤":"softenFace","素描":"sketch","自然增强":"softEnhancement","紫调":"purpleStyle","柔焦":"soften","复古":"vintage","黑白":"gray","仿lomo":"lomo","亮白增强":"strongEnhancement","灰白":"strongGray","灰色":"lightGray","暖秋":"warmAutumn","木雕":"carveStyle","粗糙":"rough"};return{getModuleName:function(n){return t[n]||n},getEasyFun:function(t){return n[t]||t}}})}("psLib"),function(t){window[t].module("corrode",function(){return{process:function(t,n){for(var r=parseInt(n[0])||3,a=t.data,e=t.width,i=t.height,o=0;e>o;o++)for(var s=0;i>s;s++)for(var h=parseInt(2*Math.random()*r)-r,c=parseInt(2*Math.random()*r)-r,u=s*e+o,h=(s+h)*e+o+c,c=0;3>c;c++)a[4*u+c]=a[4*h+c];return t}}})}("psLib"),function(t){window[t].module("curve",function(t){return{process:function(n,r){for(var a=t.lib.dorsyMath.lagrange(r[0],r[1]),e=n.data,i=n.width,o=n.height,s=0;i>s;s++)for(var h=0;o>h;h++)for(var c=h*i+s,u=0;3>u;u++)e[4*c+u]=a(e[4*c+u]);return n}}})}("psLib"),function(t){window[t].module("darkCorner",function(t){return{process:function(n,r){for(var a=parseInt(r[0])||3,e=r[1]||30,i=n.data,o=n.width,s=n.height,h=2*o/3,c=1*s/2,u=t.lib.dorsyMath.distance([h,c]),a=u*(1-a/10),d=0;o>d;d++)for(var f=0;s>f;f++)for(var l=f*o+d,p=0;3>p;p++){var g;g=i[4*l+p];var v=(t.lib.dorsyMath.distance([d,f],[h,c])-a)/(u-a);0>v&&(v=0),g=(0*Math.pow(1-v,3)+.06*v*Math.pow(1-v,2)+3*.3*v*v*(1-v)+1*Math.pow(v,3))*g*e/255,i[4*l+p]-=g}return n}}})}("psLib"),function(t){window[t].module("dorsyMath",function(t){var n={FFT1:function(t){function r(){e++;for(var o=a/Math.pow(2,e),s=a/o,h=0;o>h;h++)for(var c=h*s,u=(h+1)*s-1,d=e,f=Math.pow(2,d-1),l=0;u-f>=c;c++){var p=c+f,g=l*a/Math.pow(2,d),v=g+a/4;t[c]instanceof n.C||(t[c]=new n.C(t[c])),t[p]instanceof n.C||(t[p]=new n.C(t[p])),g=t[c].plus(t[p].mutiply(i[g])),v=t[c].plus(t[p].mutiply(i[v])),t[c]=g,t[p]=v,l++}o>1&&r()}for(var a=t.length,e=0,i=[],o=0;a>o;o++)i[o]=this.exp(-2*Math.PI*o/a);return r(),t},DFT:function(){},Matrix:function(t,n,r){var a=[];if(n){if(isNaN(n)){var e=/(\d+)\*/.exec(n)[1];n=/\*(\d+)/.exec(n)[1]}else e=n,n=r;if(t[0]&&t[0][0])for(r=0;e>r;r++){a[r]=[];for(var i=0;n>i;i++)a[r][i]=t[r][i]||0}else for(r=0;e>r;r++)for(a[r]=[],i=0;n>i;i++)a[r][i]=t[r*n+i]||0;this.m=e,this.n=n}else this.m=t.length,this.n=t[0].length;this.data=a},C:function(t,n){this.r=t||0,this.i=n||0},exp:function(t,r){t=t||0,r=r||1;var a=new n.C;return a.r=r*Math.cos(t),a.i=r*Math.sin(t),a},lagrange:function(t,n){var r=t.length;return function(a){for(var e=0,i=0;r>i;i++){for(var o=1,s=1,h=0;r>h;h++)h!=i&&(o*=t[i]-t[h],s*=a-t[h]);e+=n[i]*(s/o)}return e}},applyMatrix:function(r,a,e){e=e||0;var i=r.data,o=r.width,s=a.length;a=new n.Matrix(a,s,1);for(var h=[],c=-(Math.sqrt(s)-1)/2,u=0,d=i.length;d>u;u+=4){var f=u/4,l=parseInt(f/o),p=f%o;if(0!=l&&0!=p){for(var g=[[],[],[]],v=c;-c>=v;v++)for(var w=l+v,m=c;-c>=m;m++)for(var y=4*(w*o+(p+m)),f=0;3>f;f++)g[f].push(i[y+f]);for(l=new t.lib.dorsyMath.Matrix(g,3,s).mutiply(a),f=0;3>f;f++)h[u+f]=l.data[f];h[u+4]=i[u+4]}}for(u=0,d=i.length;d>u;u++)h[u]&&(i[u]=h[u]<e?h[u]:i[u]);return r},RGBToHSI:function(t,n,r){var a=(t-n+t-r)/2/Math.sqrt((t-n)*(t-n)+(t-r)*(n-r))||0,a=Math.acos(a),a=r>n?2*Math.PI-a:a,e=1-3*Math.min(t,n,r)/(t+n+r);return a>2*Math.PI&&(a=2*Math.PI),0>a&&(a=0),{H:a,S:e,I:(t+n+r)/3}},HSIToRGB:function(t,n,r){if(0>t?(t%=2*Math.PI,t+=2*Math.PI):t%=2*Math.PI,t<=2*Math.PI/3)var a=r*(1-n),e=r*(1+n*Math.cos(t)/Math.cos(Math.PI/3-t)),i=3*r-(e+a);else t<=4*Math.PI/3?(t-=2*Math.PI/3,e=r*(1-n),i=r*(1+n*Math.cos(t)/Math.cos(Math.PI/3-t)),a=3*r-(i+e)):(t-=4*Math.PI/3,i=r*(1-n),a=r*(1+n*Math.cos(t)/Math.cos(Math.PI/3-t)),e=3*r-(i+a));return{R:e,G:i,B:a}},applyInHSI:function(t,n){for(var r=t.data,a=0,e=r.length;e>a;a+=4){var i=this.RGBToHSI(r[a],r[a+1],r[a+2]);n(i),1<i.S&&(i.S=1),0>i.S&&(i.S=0),i=this.HSIToRGB(i.H,i.S,i.I),r[a]=i.R,r[a+1]=i.G,r[a+2]=i.B}},applyInCoordinate:function(){},distance:function(t,r){return r=r||[0,0],t=new n.C(t[0],t[1]),r=new n.C(r[0],r[1]),t.minus(r).distance()},xyToIFun:function(t){return function(n,r,a){return 4*(r*t+n)+(a||0)}},xyCal:function(t,n,r,a,e){for(var i=this.xyToIFun(t.width),o=0;3>o;o++){var s=i(n,r,o);t[s]=a(t[s])}e&&(t[s+1]=e(t[s+1]))}};return n.Matrix.prototype={plus:function(t){if(this.m!=t.m||this.n!=t.n)throw Error("矩阵加法行列不匹配");for(var r=new n.Matrix([],this.m,this.n),a=0;a<this.m;a++)for(var e=0;e<this.n;e++)r.data[a][e]=this.data[a][e]+t.data[a][e];return r},minus:function(t){if(this.m!=t.m||this.n!=t.n)throw Error("矩阵减法法行列不匹配");for(var r=new n.Matrix([],this.m,this.n),a=0;a<this.m;a++)for(var e=0;e<this.n;e++)r.data[a][e]=this.data[a][e]-t.data[a][e];return r},mutiply:function(t){if(this.n!=t.m)throw Error("矩阵乘法行列不匹配");for(var r=new n.Matrix([],this.m,t.n),a=0;a<this.m;a++)for(var e=0;e<t.n;e++){for(var i=0,o=0;o<this.n;o++)i+=this.data[a][o]*t.data[o][e];r.data[a][e]=i}return r}},n.C.prototype={plus:function(t){var r=new n.C;return r.r=this.r+t.r,r.i=this.i+t.i,r},minus:function(t){var r=new n.C;return r.r=this.r-t.r,r.i=this.i-t.i,r},mutiply:function(t){var r=new n.C;return r.r=this.r*t.r-this.i*t.i,r.i=this.r*t.i+this.i*t.r,r},divide:function(t){var r=new n.C,a=t.mutiply(t.conjugated());return t=this.mutiply(t.conjugated()),r.r=t.r/a.r,r.i=t.i/a.r,r},conjugated:function(){return new n.C(this.r,-this.i)},distance:function(){return Math.sqrt(this.r*this.r+this.i*this.i)}},n})}("psLib"),function(t){window[t].module("dotted",function(t){return{process:function(n,r){for(var a=parseInt(r[0])||1,e=parseInt(r[1])||1,i=n.data,o=n.width,s=n.height,h=2*a+1,c=[],u=e*e,e=-a;a>e;e++)for(var d=-a;a>d;d++)e*e+d*d>u&&c.push([e,d]);for(a=t.lib.dorsyMath.xyToIFun(o),e=0,o=parseInt(o/h);o>e;e++)for(d=0,u=parseInt(s/h);u>d;d++)for(var f=parseInt((e+.5)*h),l=parseInt((d+.5)*h),p=0;p<c.length;p++){var g=f+c[p][0],v=l+c[p][1];i[a(g,v,3)]=225,i[a(g,v,2)]=225,i[a(g,v,0)]=225,i[a(g,v,1)]=225}return n}}})}("psLib"),function(t){window[t].module("easy",function(){return{getFun:function(n){return{softenFace:function(){return this.clone().add(this.act("高斯模糊",10),"滤色").act("亮度",-10,5)},sketch:function(){var t=this.act("灰度处理").clone();return this.add(t.act("反色").act("高斯模糊",8),"颜色减淡").act("锐化",1)},softEnhancement:function(){return this.act("曲线",[0,190,255],[0,229,255])},purpleStyle:function(){var t=this.clone();return this.add(t.act("高斯模糊",3),"正片叠底","RG")},soften:function(){var t=this.clone();return this.add(t.act("高斯模糊",6),"变暗")},vintage:function(){return this.clone(),this.act("灰度处理").add(window[t](this.canvas.width,this.canvas.height,"#808080").act("添加杂色").act("高斯模糊",4).act("色相/饱和度调节",32,19,0,!0),"叠加")},gray:function(){return this.act("灰度处理")},lomo:function(){return this.clone().add(this.clone(),"滤色").add(this.clone(),"柔光").add(this.clone().act("反色"),"正常","20%","B").act("暗角",6,200)},strongEnhancement:function(){return this.clone().add(this.clone().act("曲线",[0,50,255],[0,234,255]),"柔光")},strongGray:function(){return this.act("灰度处理").act("曲线",[0,61,69,212,255],[0,111,176,237,255])},lightGray:function(){return this.act("灰度处理").act("曲线",[0,60,142,194,255],[0,194,240,247,255])},warmAutumn:function(){var t=this.clone().act("色相/饱和度调节",36,47,8,!0).act("暗角",6,150);return this.add(t,"叠加")},carveStyle:function(){var t=this.clone().act("马赛克").act("查找边缘").act("浮雕效果");return this.add(t,"线性光")},rough:function(){return this.add(window[t](this.canvas.width,this.canvas.height,"#000").act("喷点").act("反色").act("浮雕效果"),"叠加")}}[n]}}})}("psLib"),function(t){window[t].module("embossment",function(){return{process:function(t){for(var n=t.data,r=t.width,a=[],e=0,i=n.length;i>e;e+=4){var o=e/4,s=parseInt(o/r),h=o%r,o=4*((s-1)*r+(h-1)),c=4*(s+1)*r+4*(h+1);if(0!=s&&0!=h){for(s=0;3>s;s++)a[e+s]=n[o+s]-n[c+s]+127.5;a[e+4]=n[e+4]}}for(e=0,i=n.length;i>e;e++)n[e]=a[e]||n[e];return t}}})}("psLib"),function(t){window[t].module("gaussBlur",function(){return{process:function(t,n,r){var a,e,i,o,s,h,c=t.data,u=t.width,d=t.height,f=[],l=0;for(n=Math.floor(n)||3,r=r||n/3,a=1/(Math.sqrt(2*Math.PI)*r),o=-1/(2*r*r),s=0,r=-n;n>=r;r++,s++)i=a*Math.exp(o*r*r),f[s]=i,l+=i;for(s=0,r=f.length;r>s;s++)f[s]/=l;for(a=0;d>a;a++)for(r=0;u>r;r++){for(l=e=i=o=0,h=-n;n>=h;h++)s=r+h,s>=0&&u>s&&(s=4*(a*u+s),e+=c[s]*f[h+n],i+=c[s+1]*f[h+n],o+=c[s+2]*f[h+n],l+=f[h+n]);s=4*(a*u+r),c[s]=e/l,c[s+1]=i/l,c[s+2]=o/l}for(r=0;u>r;r++)for(a=0;d>a;a++){for(l=e=i=o=0,h=-n;n>=h;h++)s=a+h,s>=0&&d>s&&(s=4*(s*u+r),e+=c[s]*f[h+n],i+=c[s+1]*f[h+n],o+=c[s+2]*f[h+n],l+=f[h+n]);s=4*(a*u+r),c[s]=e/l,c[s+1]=i/l,c[s+2]=o/l}return t.data=c,t}}})}("psLib"),function(t){window[t].module("borderline",function(t){return{process:function(n){return t.lib.dorsyMath.applyMatrix(n,[0,1,0,1,-4,1,0,1,0],250)}}})}("psLib"),function(t){window[t].module("mosaic",function(){return{process:function(t,n){for(var r=parseInt(n[0])||3,a=t.data,e=t.width,i=t.height,r=2*r+1,o=0,s=parseInt(e/r);s>o;o++)for(var h=0,c=parseInt(i/r);c>h;h++){for(var u=[],d=[0,0,0],f=0;r>f;f++)for(var l=0;r>l;l++){var p=(h*r+f)*e+o*r+l;d[0]+=a[4*p],d[1]+=a[4*p+1],d[2]+=a[4*p+2]}for(u[0]=d[0]/(r*r),u[1]=d[1]/(r*r),u[2]=d[2]/(r*r),f=0;r>f;f++)for(l=0;r>l;l++)p=(h*r+f)*e+o*r+l,a[4*p]=u[0],a[4*p+1]=u[1],a[4*p+2]=u[2]}return t}}})}("psLib"),function(t){window[t].module("noise",function(){return{process:function(t,n){for(var r=parseInt(n[0])||100,a=t.data,e=t.width,i=t.height,o=0;e>o;o++)for(var s=0;i>s;s++)for(var h=s*e+o,c=0;3>c;c++){var u=parseInt(2*Math.random()*r)-r;a[4*h+c]+=u}return t}}})}("psLib"),function(t){window[t].module("oilPainting",function(){return{process:function(t,n){for(var r=parseInt(n[0])||16,a=t.data,e=t.width,i=t.height,o=0;e>o;o++)for(var s=0;i>s;s++){for(var h=s*e+o,c=0,u=0;3>u;u++)c+=a[4*h+u];for(c/=3,c=parseInt(c/r)*r,u=0;3>u;u++)a[4*h+u]=c}return t}}})}("psLib"),function(t){window[t].module("setHSI",function(t){return{process:function(n,r){return r[0]=r[0]/180*Math.PI,r[1]=r[1]/100||0,r[2]=255*(r[2]/100)||0,r[3]=r[3]||!1,t.lib.dorsyMath.applyInHSI(n,function(t){r[3]?(t.H=r[0],t.S=r[1]):(t.H+=r[0],t.S+=r[1]),t.I+=r[2]}),n}}})}("psLib"),function(t){window[t].module("sharp",function(){return{process:function(t,n){for(var r=n[0]||.6,a=t.data,e=t.width,i=0,o=a.length;o>i;i+=4){var s=i/4,h=parseInt(s/e),c=s%e;if(0!=h&&0!=c)for(var u=4*((h-1)*e+(c-1)),h=4*((h-1)*e+c),s=4*(s-1),c=0;3>c;c++)a[i+c]+=(a[i+c]-(a[h+c]+a[s+c]+a[u+c])/3)*r}return t}}})}("psLib"),function(t){window[t].module("toGray",function(){return{process:function(t){for(var n=t.data,r=0,a=n.length;a>r;r+=4){var e=parseInt((n[r]+n[r+1]+n[r+2])/3);n[r+2]=n[r+1]=n[r]=e}return t.data=n,t}}})}("psLib"),function(t){window[t].module("toReverse",function(){return{process:function(t){for(var n=t.data,r=0,a=n.length;a>r;r+=4)n[r]=255-n[r],n[r+1]=255-n[r+1],n[r+2]=255-n[r+2];return t.data=n,t}}})}("psLib"),function(t){window[t].module("toThresh",function(t){return{process:function(n,r){n=t.lib.toGray.process(n);var a=n.data;r=r[0]||128;for(var e=0,i=a.length;i>e;e++)(e+1)%4&&(a[e]=a[e]>r?255:0);return n.data=a,n}}})}("psLib");